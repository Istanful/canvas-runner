<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title></title>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script>
      class Graphic {
        constructor(path) {
          this.path = path;
          this.load();
        }

        load() {
          this.image = new Image();
          this.image.src = this.path;
        }
      }

      class Drawer {
        static get ctx() {
          return Drawer.canvas.getContext('2d');
        }

        static get canvas() {
          return document.getElementById('canvas')
        }

        static clear() {
          Drawer.ctx.clearRect(0, 0, Drawer.canvas.width, Drawer.canvas.height);
        }
      }

      class Animation {
        nextValue(time) {
        }
      }

      class SpriteAnimation extends Animation {
        constructor(spriteSheet, framesPerSecond) {
          super();
          this.spriteSheet = spriteSheet;
          this.framesPerSecond = framesPerSecond;
        }

        nextValue(time) {
          return this.spriteSheet.getFrame(this.frameIndex(time));
        }

        frameIndex(time) {
          return Math.floor(
            (time / this.frameDuration) % (this.spriteSheet.columnCount)
          );
        }

        get frameDuration() {
          return 1000 / this.framesPerSecond;
        }
      }

      class Game {
        constructor() {
          this.gameObjects = [];
        }

        update() {
          Drawer.clear();
          this.gameObjects.forEach((gameObject) => {
            return gameObject.update(this.currentTime)
          });
        }

        get currentTime() {
          return new Date().getTime()
        }
      }

      class GameObject {
        constructor(name) {
          this.name = name;
        }

        update(time) {
          this.draw(time);
        }

        draw(time) {
        }

        instantiate(game) {
          game.gameObjects.push(this);
        }
      }

      class SpriteSheet {
        constructor(graphic, columnCount) {
          this.graphic = graphic;
          this.columnCount = columnCount;
        }

        frameAt(time) {
          return this.getFrame(this.frameIndex(time));
        }

        getFrame(index) {
          const canvas = document.createElement('canvas')
          canvas.width = this.frameWidth;
          canvas.height = this.frameHeight;
          canvas.getContext('2d').drawImage(
            this.graphic.image,
            this.frameWidth * index,
            0,
            this.frameWidth,
            this.frameHeight,
            0,
            0,
            this.frameWidth,
            this.frameHeight,
          );
          return canvas;
        }

        get frameWidth() {
          return this.graphic.image.width / this.columnCount;
        }

        get frameHeight() {
          return this.graphic.image.height;
        }

        get frameDuration() {
          return 1000 / 14;
        }

        frameIndex(time) {
          return Math.floor(
            (time / this.frameDuration) % (this.columnCount)
          );
        }
      }

      class Renderer extends Animation {
        constructor(gameObject) {
          super();
          this.gameObject = gameObject;
        }

        draw(position, time) {
          Drawer.ctx.drawImage(
            this.gameObject.graphic(time),
            position.x,
            position.y
          );
        }

        frameIndex(time) {
          return Math.floor(
            (time / this.frameDuration) % (this.columnCount)
          );
        }

        get frameDuration() {
          return 1000 / this.framesPerSecond;
        }
      }

      class Character extends GameObject {
        constructor(name) {
          super(name);
          const graphic = new Graphic('assets/character.png');
          this.animation = new SpriteAnimation(new SpriteSheet(graphic, 5), 14)
          this.renderer = new Renderer(this);
          this.position = new Vector(0, 0);
        }

        update(time) {
          this.position = this.position.add(new Vector(2, 0));
          super.update(time);
        }

        draw(time) {
          this.renderer.draw(this.position, time)
        }

        graphic(time) {
          return this.animation.nextValue(time);
        }
      }

      class Vector {
        constructor(x, y) {
          this.x = x;
          this.y = y;
        }

        add(other) {
          return new Vector(
            this.x + other.x,
            this.y + other.y
          );
        }
      }

      const game = new Game();
      const character = new Character('test');
      character.instantiate(game);

      setInterval(() => {
        game.update();
      }, 16)
    </script>
  </body>
</html>
